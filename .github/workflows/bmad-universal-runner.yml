name: BMAD Universal Runner (Central)
on:
  workflow_call:
    inputs:
      bmad_workflow_path:
        required: true
        type: string
        description: "The relative path to the BMAD workflow directory (e.g., '4-implementation/dev-story')"
    secrets:
      BMAD_CENTRAL_TOKEN:
        required: true
        description: "PAT with read access to the private mm-bmad repository"

jobs:
  run-bmad-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Caller Repository
        uses: actions/checkout@v4

      - name: Checkout Central Brain (mm-bmad)
        uses: actions/checkout@v4
        with:
          repository: jcampb/mm-bmad
          path: .mm-bmad
          token: ${{ secrets.BMAD_CENTRAL_TOKEN }}

      # We copy the universal agent definition into the workspace so GH-AW can execute it
      # while dynamically replacing the {{inputs.bmad_workflow_path}} variable
      - name: Prepare Agent Prompt
        run: |
          mkdir -p .agents
          cat .mm-bmad/agents/bmad-universal-wrapper.md \
          | sed 's|${{ inputs.bmad_workflow_path }}|${{ inputs.bmad_workflow_path }}|g' \
          > .agents/bmad-universal-wrapper.md

      - name: Run GH-AW Universal Agent
        uses: github/gh-aw@v1
        with:
          agent: .agents/bmad-universal-wrapper.md
          github-token: ${{ secrets.GITHUB_TOKEN }}
